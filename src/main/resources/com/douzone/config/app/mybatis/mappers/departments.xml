<?xml version="1.0" encoding="UTF-8" ?> 

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="departments">
	<select id="getList" resultType="departmentsvo">
	    select a.no as no, a.name as name, a.g_no as gNo, a.o_no as oNo, a.depth as depth, a.p_no as parents 
	      from departments a, company b 
	     where a.company_no = b.no
<!-- 	       and b.no = ${value} -->
	  order by a.g_no asc, a.o_no asc
	</select>
	
	<insert id="add_t_co_dept" parameterType="departmentsvo">
		<![CDATA[
			insert into t_co_dept VALUES
				( (select dep from (select max(dept_seq + 0) + 1 as dep from t_co_dept ) a),
																					   null, 
																					   #{groupSeq}, 
																					   #{compSeq}, 
																					   #{deptSeq}, 
																					   10000001, 
																					   NULL, 
																					   '', 
																					   NULL, 
																					   '', 
																					   NULL, 
																					   null, 
																					   'N', 
																					   'Y', 
																					   'kr', 
																					   '', 
																					   null, 
																					   1, 
																					   NULL,
																					   'Y', 
																					   '0101', 
																					   date_format(now(), '%Y-%m-%d %h:%m:%s'),
																					   null,
																					   null, 
																					   NULL, 
																					   'Y')
		]]>
	</insert>
	
	<insert id="add_t_co_dept_multi" parameterType="departmentsvo">
		<![CDATA[
			INSERT INTO `t_co_dept_multi` VALUES
					(	
						'kr', 
						(select max(dept_seq + 0) from t_co_dept), 
						#{groupSeq},
						#{compSeq},
						#{bizSeq},
						#{deptName}, 
						NULL, 
						NULL, 
						'',
						'', 
						#{deptName}, 
						'Y', 
						'0101', 
						date_format(now(), '%Y-%m-%d %h:%m:%s'), 
						null, 
						null, 
						null
					)
		]]>
	</insert>
	
	<select id="get_t_co_biz_info" parameterType="Long" resultType="bizvo">
		<![CDATA[
			select group_seq as groupSeq, comp_seq as compSeq from t_co_biz where biz_seq = 10000001;
		]]>
	</select>
	
	
	<!-- 부서 밑에 부서추가 -->
	
	<!-- <select id="getParentDepartmentInfo" parameterType="long" resultType="departmentsvo">
	
		<![CDATA[
			 select no, name, g_no as gNo, o_no as oNo, depth, p_no as parents
		    	from departments 
		    		where no = #{value} order by gNo asc, oNo asc
		]]>
	 
	</select>
	
	<select id="get" parameterType="departmentsvo" resultType="departmentsvo">
		
		 <choose>
			getMinOno
			<when test="gNo != null and oNo != null and depth != null">
				<![CDATA[
					select min(o_no) as oNo
						from departments
							where g_no = #{gNo} and o_no > #{oNo} and depth <= #{depth}
				]]>
			</when>
			
			ifnullMaxOnoPlusOne
			<when test="no == null and companyNo == null and parents == null and oNo == null and depth == null">
				<![CDATA[
					select max(o_no) + 1 as oNo
						from departments
							where g_no = #{gNo}
				]]>
			</when>
			
			자회사 밑에 부서 추가
			getMaxGno
			<when test="no == null and companyNo == null and gNo == null and oNo == null and depth == null ">
				<![CDATA[
					select count(*) + 1 as gNo
						from departments
							where p_no = #{parents}
				]]>
			</when>
			
			부서 추가시 CompanyNo 구하기위해서 사용하는 쿼리
			<when test="no != null">
				<![CDATA[
					select p_no as parents from departments where no = #{no}
				]]>
			</when>
		</choose>
		
	</select>
	
	 <update id="ifnotnullupdateOnoPlusOne" parameterType="departmentsvo">
		<![CDATA[
			update departments 
				set o_no = o_no + 1 
					where g_no = #{gNo} and o_no >= #{oNo}
		]]>
	</update>  -->
	
	<!-- <insert id="addDepartment" parameterType="departmentsvo">
		<![CDATA[
			insert into departments values (null, #{name}, #{gNo}, #{oNo}, #{depth}, #{parents})
		]]>
		<selectKey keyProperty="no" resultType="Long" order="AFTER">
			<![CDATA[
				select last_insert_id()
			]]>
		</selectKey>
	</insert> -->
	
	<!-- 부서 삭제 -->
	<delete id="deleteDepartment" parameterType="Long">
		<![CDATA[
			delete from departments where no = #{value};
		]]>
	</delete>
	
	<!-- 더미데이터  -->
	<select id="getCount" resultType="int">
		select count(*) from departments
	</select>
	
	<select id="getCountByPno" resultType="int" parameterType="int">
		select count(*) from departments where p_no = #{parents}
	</select>
	
	<select id="getNameByPno" resultType="string" parameterType="int">
		select name from departments where no = #{no}
	</select>
	
	<select id="selectParentNo" parameterType="long" resultType="departmentsvo">
		<![CDATA[
			select no from departments where p_no = #{value};
		]]>
	</select>
	
</mapper>